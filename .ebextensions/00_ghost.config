option_settings:
  - namespace: aws:elasticbeanstalk:container:nodejs
    option_name: NodeVersion
    value: 0.10.21
  - option_name: DB_HOST
    value: blogthucdon24instance.cljkx7d1qnff.ap-southeast-1.rds.amazonaws.com
  - option_name: DB_USER
    value: muzix
  - option_name: DB_PWD
    value: thucdon24
  - option_name: DB_NAME
    value: blogthucdon24db
  - option_name: AWS_ACCESS_ID
    value: AKIAJ4BLOM73M4B3BDGQ
  - option_name: AWS_ACCESS_SECRET
    value: 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
  - option_name: AWS_BUCKET_NAME
    value: blogthucdon24bucket
  - option_name: AWS_BUCKET_REGION
    value: ap-southeast-1
files:
  "/etc/nginx/conf.d/000_elastic_beanstalk_proxy.conf":
    content: |
      upstream nodejs {
        server 127.0.0.1:8081;
        keepalive 256;
      }

      server {
        listen 8080;

        gzip on;
        gzip_comp_level 6;
        gzip_disable "msie6";
        gzip_min_length 150;
        gzip_proxied any;
        gzip_types text/plain text/xml text/css application/json application/javascript;
        gzip_vary on;

        location ~* \.(db|hbs|conf)$  { deny all; }
        location ~ /\.ht { deny all; }
        location ~ /\. { deny all; }
        location ~ ~$  { deny all; }

        location ~ ^/(sitemap\.xml|robots\.txt|favicon\.ico)$ {
            root /var/app/current/public;
            access_log off;
            log_not_found off;
        }

        # Static files served directly by Nginx
        location ~ ^/assets/(img|js|css|fonts)/  {
            root /var/app/current/content/themes/casper;
            expires 30d;
            access_log off;
        }

        location ~ ^/(img/|css/|lib/|vendor/|fonts/) {
            root /var/app/current/core/client/assets;
            expires 30d;
            access_log off;
        }

        location ~ ^/(bower_components/) {
            root /var/app/current;
            expires 30d;
            access_log off;
        }

        location ~ ^/(content/images/) {
            root /var/app/current;
            expires 30d;
            access_log off;
        }

        location ~ ^/(shared/|built/) {
            root /var/app/current/core;
            expires 30d;
            access_log off;
        }

        location ~ ^/public/ {
            root /var/app/current/core/built;
            expires 30d;
            access_log off;
        }

        location / {
            proxy_pass  http://nodejs;
            proxy_set_header   Connection "";
            proxy_http_version 1.1;
            proxy_set_header        Host            $host;
            proxy_set_header        X-Real-IP   $remote_addr;
            proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
            add_header Link "<$scheme://tech.thucdon24.com$request_uri>; rel=\"canonical\"";
        }
      }
packages:
   yum:
      git: []
      gcc: []
      gcc-c++: []
      make: []
      openssl-devel: []
container_commands:
   00-install-grunt:
      command: "npm install -g grunt-cli"
      env:
          HOME: "/root"
          PATH: "/sbin:/bin:/usr/sbin:/usr/bin:/opt/aws/bin:/opt/elasticbeanstalk/node-install/node-v0.10.21-linux-x64/bin"
   10_pre_install_sqlite3:
      command: "npm install sqlite3@3.0.4 --build-from-source"
      cwd: "/tmp/deployment/application"
      env:
          HOME: "/root"
          PATH: "/sbin:/bin:/usr/sbin:/usr/bin:/opt/aws/bin:/opt/elasticbeanstalk/node-install/node-v0.10.21-linux-x64/bin"
   11_install_ghost_dependency:
      command: "npm install"
      cwd: "/tmp/deployment/application"
      env:
          HOME: "/root"
          PATH: "/sbin:/bin:/usr/sbin:/usr/bin:/opt/aws/bin:/opt/elasticbeanstalk/node-install/node-v0.10.21-linux-x64/bin"
   12_grunt_ghost:
      command: "grunt init --force"
      cwd: "/tmp/deployment/application"
      env:
          HOME: "/root"
          PATH: "/sbin:/bin:/usr/sbin:/usr/bin:/opt/aws/bin:/opt/elasticbeanstalk/node-install/node-v0.10.21-linux-x64/bin"
   13_grunt_ghost:
      command: "grunt prod"
      cwd: "/tmp/deployment/application"
      env:
          HOME: "/root"
          PATH: "/sbin:/bin:/usr/sbin:/usr/bin:/opt/aws/bin:/opt/elasticbeanstalk/node-install/node-v0.10.21-linux-x64/bin"
   14_copy_pyscript:
      command: "cp .ebextensions/99rewrite_nginx_config.py /opt/elasticbeanstalk/hooks/appdeploy/enact/"
   15_chmod_pyscript:
      command: "chmod +x /opt/elasticbeanstalk/hooks/appdeploy/enact/99rewrite_nginx_config.py"
